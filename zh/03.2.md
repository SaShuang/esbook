# 3.2 SQL触发器应用示例

### 回写采购订单状态
> @家里地位第三：  
![](images/3.2.1.jpg?raw=true)

### 解决ES版本号丢失问题  
> @XゅY 
![](images/3.2.2.jpg?raw=true)

### 更新采购订单状态
> @Kang
```sql
/*
采购订单结案  2016-4-15
新建采购入库单,更新采购订单已交数量.
当该采购单中所有物品交齐后，触发器更新主表的状态字段
*/
Create trigger 采购单结案 on 采购订单M                  
For Update   
AS
IF UPDATE(已交数量)
BEGIN
     UPDATE 采购订单M SET 状态=(CASE WHEN ISNULL(已交数量,0)=ISNULL(数量,0) THEN 1 ELSE 0 END)
END
BEGIN
     SET NOCOUNT ON;
     UPDATE 采购订单Z SET 状态=CASE WHEN A.CLOSED=1 THEN '未完成' ELSE '已完成' end
     FROM
	(SELECT EXCELSERVERRCID,MAX(CASE WHEN ISNULL(状态,0)=0 THEN 1 ELSE 0 END) CLOSED
	 FROM 采购订单M
	 WHERE EXCELSERVERRCID IN (SELECT EXCELSERVERRCID FROM INSERTED
		                   UNION 
		                   SELECT EXCELSERVERRCID FROM DELETED)
	GROUP BY EXCELSERVERRCID
	) A
     WHERE 采购订单Z.EXCELSERVERRCID=A.EXCELSERVERRCID             
END
```

### 工作台防止删单导致负库存示例( asked by @昆明haotian )
> @村长
```sql
create trigger ck on io --io是入库单主表，ios是入库单明细
instead of delete
as 
begin
declare @ct int
select @ct=(select COUNT(*)  --TODO:如果明细允许多个料号，则需要用sum函数聚合qty并按id分组
	from deleted,ios,库存 
	where deleted.ExcelServerRCID=ios.excelserverrcid and ios.id=库存.id and ios.qty>库存.qty)
if (@ct>0)
raiserror('库存不允许为负！',16,1)
end
```

效果图：

![](images/3.2.3.jpg?raw=true)

## links
  * [目录](<preface.md>)
  * 上一节: [上一节](<03.1.md>)
  * 下一节: [下一节](<03.3.md>)
